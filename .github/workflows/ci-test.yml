name: CI - Test and Build

on:
  push:
    branches: [main, develop, 'release/*']
  pull_request:
    branches: [main, develop]

# Restrict default permissions for security
permissions:
  contents: read

env:
  GO_VERSION: '1.21'
  TERRAFORM_VERSION: '1.10.0'

jobs:
  # Unit tests for Go services
  test-go-services:
    name: Go Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write  # For test results
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run tests - tenant-mapper
        working-directory: services/tenant-mapper
        run: |
          go mod download
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./services/tenant-mapper/coverage.out
          flags: tenant-mapper
          name: tenant-mapper-coverage

  # Build Go services
  build-go-services:
    name: Build Go Services
    runs-on: ubuntu-latest
    needs: test-go-services
    permissions:
      contents: read
    strategy:
      matrix:
        service: [tenant-mapper]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build service
        working-directory: services/${{ matrix.service }}
        run: |
          go mod download
          CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o ${{ matrix.service }} .

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.service }}-binary
          path: services/${{ matrix.service }}/${{ matrix.service }}

  # Docker build and security scan
  docker-build-scan:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    needs: build-go-services
    permissions:
      contents: read
      security-events: write  # For uploading SARIF results
    strategy:
      matrix:
        dockerfile: [Dockerfile, Dockerfile.dev]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false
          load: true
          tags: tenant-mapper:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: tenant-mapper:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Integration tests with Docker Compose
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker-build-scan
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create monitoring config directory
        run: |
          mkdir -p monitoring/prometheus monitoring/grafana/dashboards monitoring/grafana/datasources
          touch monitoring/prometheus/prometheus-config.yaml

      - name: Create basic Prometheus config
        run: |
          cat > monitoring/prometheus/prometheus-config.yaml << EOF
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
          EOF

      - name: Start services with Docker Compose
        run: docker-compose up -d redis tenant-mapper

      - name: Wait for services to be ready
        run: |
          timeout 60 bash -c 'until docker-compose ps | grep -q "Up"; do sleep 2; done'
          sleep 10

      - name: Test tenant-mapper health endpoint
        run: |
          curl -f http://localhost:8080/health || exit 1

      - name: Test Redis connectivity
        run: |
          docker-compose exec -T redis redis-cli ping

      - name: Show service logs on failure
        if: failure()
        run: docker-compose logs

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # E2E tests
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create monitoring configs
        run: |
          mkdir -p monitoring/prometheus monitoring/grafana/dashboards monitoring/grafana/datasources
          cat > monitoring/prometheus/prometheus-config.yaml << EOF
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
          EOF

      - name: Start full stack
        run: docker-compose up -d

      - name: Wait for all services
        run: |
          sleep 20
          docker-compose ps

      - name: Run E2E test scenarios
        run: |
          # Test 1: Health checks
          echo "Testing health endpoints..."
          curl -f http://localhost:8080/health

          # Test 2: Redis storage and retrieval
          echo "Testing Redis connectivity..."
          docker-compose exec -T redis redis-cli SET test:key "test-value"
          docker-compose exec -T redis redis-cli GET test:key | grep -q "test-value"

          # Test 3: Prometheus metrics
          echo "Testing Prometheus..."
          curl -f http://localhost:9090/-/healthy

          echo "All E2E tests passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          docker-compose logs redis
          docker-compose logs tenant-mapper

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # Validate Kubernetes manifests
  validate-k8s:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Validate overlays
        run: |
          for env in dev staging production; do
            echo "Validating $env overlay..."
            kustomize build kubernetes/overlays/$env > /tmp/manifests-$env.yaml
          done

  # Validate Helm charts
  validate-helm:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Lint Helm charts
        run: |
          helm lint helm/charts/saas-platform
          helm lint helm/charts/infrastructure
          helm lint helm/charts/microservices

      - name: Template Helm charts
        run: |
          for env in dev staging prod; do
            echo "Templating $env environment..."
            helm template test helm/charts/saas-platform \
              -f helm/charts/saas-platform/values.$env.yaml \
              > /tmp/helm-$env.yaml
          done

  # Validate Terraform
  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        environment: [dev, staging, production]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform validate

      - name: Run tfsec security scan
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: terraform/environments/${{ matrix.environment }}
          soft_fail: true

  # Summary job
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [test-go-services, build-go-services, docker-build-scan, integration-tests, e2e-tests, validate-k8s, validate-helm, validate-terraform]
    if: success()
    permissions:
      contents: read
    steps:
      - name: Success
        run: |
          echo "âœ… All CI checks passed successfully!"
          echo "Pipeline completed at: $(date)"
